# MySQL

<img src="https://upload.wikimedia.org/wikipedia/ru/thumb/d/d3/Mysql.png/310px-Mysql.png" width=200>

**MySQL** - реляционная клиент-серверная СУБД. Распространяется под свободной (GPL) и коммерческой лицензией, разрабатывается Oracle.

В дистрибутив входит серверное приложение и клиентское приложение MySQL Workbench.

Входит в состав популярных сборок сервером для веб-разработки: Денвер, WAMP, LAMP, XAMPP и др.

Реализована для большинства платформ включая Windows, Linux, MacOS.

Имеет API для популярных языков включая Python, C++, C, Java, C#.

Информация о MySQL на сайте https://stackshare.io/mysql.


### Установка

[Последняя версия (на март 2024) - 8.3.0](https://www.mysql.com/downloads/).
Версия MySQL Community (GPL) бесплатна.


**Ubuntu**
```bash
# устанвока
sudo apt install mysql-server

# запуск сервиса
sudo systemctl start mysql.service
# проверить состояние сервиса
sudo systemctl status mysql.service


# установка клиентского приложения Workbench
sudo snap install mysql-workbench-community

# Установка только клиентского приложения (консольного)
sudo apt install mysql-client
```

**Windows**
...

Подробнее об установке: 
https://selectel.ru/blog/tutorials/how-to-install-mysql-on-windows/ \
или https://www.mysqltutorial.org/getting-started-with-mysql/install-mysql/ (английский) 
или https://dev.mysql.com/doc/refman/8.3/en/installing.html (английский) 



## Настройка докер образа
Скачать базовый официальный образ MySQL c dockerhub [https://hub.docker.com/_/mysql]
```bash
docker pull mysql
```

Запустить образ

```bash
docker run --name some-mysql -e MYSQL_ROOT_PASSWORD=my-secret-pw   -v my_data_folder:/var/lib/mysql   -p 3333:3306  -d mysql:tag
```
- `--name my-mysql-cont` имя контейнера (в примера задано `my-mysql-cont`)
- `-e` — ключ, после которого передаются значения переменных окружения
	-`MYSQL_ROOT_PASSWORD` — пароль суперпользователя
- `-v` — подключить к контейнеру внешнюю папку\
	 `my_data_folder:/var/lib/mysql` — внешняя папка - `my_data_folder`,  `/var/lib/mysql` - папка внутри контейнера, в ней MySQL сохраняет данные БД.
	 Обращение MySQL к своей паке будут перенаправляться к `my_data_folder`. Это внешнее хранилище необходимо, т.к. контейнер не может сохранять своё состояние от запуска к запуску.
- `-p 3333:3306` — проброс 3306 порта контейнера в основную ОС под номером 3333
- `-d` — запуск в режиме демона (фонового процесса, сервиса)	
- `mysql:tag` — название и версия образа

Имя папки, где хранятся БД записано в переменной datadir:
```sql
select @@datadir
```

**Подключение к серверу в контейнере докера**
```bash
mysql -h 127.0.0.1 -u root -p --port 3333
```
- `-h 127.0.0.1` — адрес хоста;
- `-u root` — имя пользователя (здесь `root`);
- `-p` — запросить пароль;
- `--port 3333` порт для подключения (по умолчанию 3306, указывать не нужно).

### Пример начальной настройки
Создать БД
```sql
create database my_database_name;
```

```sql
create user 'user01'@'%'
identified by 'user01';

FLUSH PRIVILEGES;

grant all priveleges 
on my_database_name.*
to 'user01'@'%';

```

Проверить права
```bash
show grants for 'user01'@'%';
```




## Начальная настройка, создание пользователей

#### Задание пароля доступа главного администратора (суперпользоватея) к серверу СУБД
**Linux**

**Запустить консольное клиентское приложение от имени суперпользователя:**
```bash
sudo mysql
```
Запуск от имени суперпользователя позволит настроить сервер без ввода пароля администратора СУБД.
Клиентское приложение должно быть запущено на том же устройстве, что и сам сервер. 


**Задать пароль администратора (root) СУБД**
```sql
ALTER USER root@localhost 
IDENTIFIED WITH mysql_native_password  
BY '<YOUR_PASSWORD>';
```
где `<YOUR_PASSWORD>` обозначает задаваемый пароль.  Важно не потерять этот пароль.
В MySQL имя пользователя состоит из двух частей: непосредственно имя пользователя и имени хоста. Последнее может быть опушено, тогда вместо него записывают `%`. В примере выше имя пользователя - `root`, имя хоста - `localhost`.



Далее можно запускать клиентское приложение mysql от имени суперпользователя СУБД так:
```bash
mysql -u root -p
```



#### Создание дополнительных пользователей, с меньшим набором привилегий
Пользователь root обладает максимальными привилегиями.
Однако, для большинства задач администрирования СУБД максимальные привилегии не требуются.

Нужно соблюсти принцип наименьших привилегий и создать пользователя, у которого привилегий будет не больше, чем это необходимо для всех задач администрирования БД внутри СУБД.

```sql
create user test@localhost 
identified by 'test' 
comment 'тестовый пользователь';
--обновить привилегии пользователей без перезагрузки сервера
FLUSH PRIVILEGES;
```
Создание пользователя test с хостом localhost и паролем test. Хорошая практика добавлять к пользователю его краткое описание (после ключевого слова comment).


Просмотреть список пользователей через выполнение запроса к таблице user служебной базы данных mysql:
```sql
select user from mysql.user;
```


**Настройка привилегий**
```sql
GRANT privilege [,privilege],.. 
ON privilege_level 
TO account_name;
```

Уровни привилегий
<img src="https://www.mysqltutorial.org/wp-content/uploads/2019/09/MySQL-Grant-Privilege-Level.png">

- Global (глобальный уровень) - `*.*` - привилегии для всех БД, на все таблицы. Может создавать БД, таблицы.
- Database (уровенб БД), например `my_database.*` привилегии даны только для БД my_database, на все таблицы этой БД. Может создавать таблицы внутри своей БД.
- ...

Показать привилегии пользователя
```sql
SHOW GRANTS FOR <user@host>;
```
привилегий может быть очень много, для удобного отображений таблиц в консоль можно добавить ключ `\G` в конец запроса. Например:
```sql
SHOW GRANTS FOR root@localhost\G
```


Некоторые привилегии:
- `usage` - минимальный уровень привилегий, можно только войти на сервер. Выдаётся по умолчанию.
- `all` - максимальные привилегии.


По умолчанию новый пользователь не может создавать других пользователей с такими же привилегиями. Чтобы добавить такую возможность пользователю необходимо добавить `WITH GRANT OPTION` в операцию наделения полномочиями:

```sql
GRANT ALL PRIVILEGES ON *.* TO 'admin_ivanov'@'%' WITH GRANT OPTION;
FLUSH PRIVILEGES;
```
Пользователю `admin_ivanov` с любого хоста (`%`) даются полные привилегии (`ALL PRIVELEGES`), он может давать аналогичные привилегии другим пользователям (`WITH GRANT OPTION`). Добавлять пользователей с такими правами рекомендуется, если СУБД должны администрировать несколько людей. При необходимости всегда можно удалить этих пользователей. При этом можно дополнительно ограничить IP адрес, с которого пользователь может подключаться.


При необходимости можно добавить или изменить привилегии пользователя. Например, можно отдельно дать возможность создавать пользователей:
```sql
GRANT   CREATE USER   ON *.*   TO 'admin_petrov'@'%';
```

Показать имя текущего пользователя можно вызвав функцию user:
```sql
select user();
```

**Удаление пользователя**
```sql
DROP USER 'some_user'@'somehost.somedomain';
FLUSH PRIVILEGES;
```

<br>

**См. также роли пользователей**. Роли упрощают выдачу одинаковых привилегий для большого числа пользователей.

https://selectel.ru/blog/tutorials/how-to-create-a-new-user-and-set-privileges-in-mysql/ - Создание нового пользователя и настройка прав в MySQL


<br>

**Дополнительно**

Показать все существующие БД можно так:
```sql
show databases;
```

Выход из консольного клиента:
```text
exit;
```

Выполнить консольную команду из mysql клиента:
```sql
system <my-command>

\! <my-command>
```

Запустить скрипт безопасности для завершения настройки
```bash
sudo mysql_secure_installation
```
Скрипт будет выполняться в режиме мастера, нужно ответить на вопросы о настройке безопасности: удалить анонимных пользователей, запретить пользователю root подключаться по сети, удалить тестовую БД test

См. также `mysqladmin` - клиентское приложение MySQL для администрирования сервера.


# Подключение
Для подключения к серверу MySQL можно использовать любое клиентское приложение
- mysql, mysqladmin - консольное клиентское приложение и приложение для администрирования
- MySQL Workbench - клиентское приложение (с дополнительными возможностями для проектирование БД)
- DBeaver - универсальное клиентское приложения для СУБД
- DataGrip - универсальное клиентское приложения для СУБД, студенческая лицензия (единственная бесплатная) в настоящее время недоступна в РФ.
- phpMyAdmin


По умолчанию сервер принимает подключения только с локального хоста. Это записано в файле конфигурации `mysqld.cnf`. Буква `d` в названии файла значит, что это файл конфигурации сервиса (демона, в привычной терминологии Linux), а не одноимённой клиентской программы. В linux этот файл обычно находится в папке `etc` (хранит файлы конфигурации программ): `/etc/mysql/mysql.conf.d/mysqld.cnf`. 


```
# по умолчанию: bind-address            = 127.0.0.1
# разрешить подключения в любого IP
bind-address            = 0.0.0.0
```

После редактирования файла конфигурации сервер нужно перезапустить.


По умолчанию MySQL сервер ждёт подключений на порту 3306.


**Подключение и выполнение локального sql файла**

```bash
mysql -h <ip>   -u <user_name>  -p  < мой_sql_файл.sql 
```

Консольный оператор `<` скопирует содержимое файла (указывается после него) в консоль mysql (так будто они были введены вручную), все команды из этого файла выполняется автоматически.

#### Подключение к удалённому серверу
```bash
mysql -h <ip>
```

Например 
```bash
mysql -h 192.168.1.1 -u user_db0 -p
```
Подключиться к серверу по адресу `192.168.1.1` (адрес в локальной сети) с именем пользователя `user_db0`, `-p` — после подключения будет запрошен пароль пользователя. 

## Создание БД, таблиц.


Создание новой базы данных
```sql
create database [if not exists] <database_name>;
```
`create scheme` - синоним (в MySQL).

Показать существующие БД: `show databases`;

Задать текущую БД
```sql
use database_name;
```
Задавать текущую БД полезно, так не придётся каждый раз указывать имя БД при обращением к таблице.

Создание таблицы.
```sql
CREATE TABLE test_db.Staff (    
	id       		INT          	PRIMARY KEY AUTO_INCREMENT,    
	name     		VARCHAR(255) 	NOT NULL,    
	position 		VARCHAR(30),    
	birthday 		DATE         	NOT NULL,    
	has_children 	BOOLEAN  		DEFAULT(FALSE) NOT NULL,    
	phone 			VARCHAR(20)     UNIQUE NOT NULL  
	);
```

`test_db` - имя БД, если БД выбрана (`use database`) то указывать не обязательно.

Показать список таблиц в текущей БД
```sql
show tables;
```

Добавление данных в таблицу:
```sql
insert into Staff (name, position, birthday, phone )
values ('Ivanov Ivan', 'Selesman', '1980-09-30', '+7 123 4567');
```


## Пример 

1. Скачайте архив с примером: https://github.com/datacharmer/test_db/archive/refs/heads/master.zip. Распакуйте архив.
2. Выполните файл `employees.sql`. Он создаст БД `employees`, необходимые таблицы и загрузит в них данные из `.dump` файлов.
```bash
mysql -h <ip>   -u <user_name>  -p  < employees.sql 
```


# Производительность
Индексы

# Резервное копирование

# Системные переменные

Просмотреть список системных переменных:

```sql
show variables
```

Системные переменные можно изменять динамически во время работы сервера 
с помощью команды SET. Например, изменить значение системной переменной:

```sql
SET GLOBAL variable_name = value;
```



Активные соединения:
```sql
show processlist;
```

# Ссылки
- https://www.mysqltutorial.org/